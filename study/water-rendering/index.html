<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Rendering (물/파도 렌더링) - MSH Portfolio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            color: #333;
            line-height: 1.8;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .nav {
            margin-bottom: 40px;
        }

        .nav a {
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            margin-right: 12px;
        }

        .nav a:hover {
            color: #333;
        }

        .header {
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #111;
        }

        .header-meta {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .header-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            background: #2196F3;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #111;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196F3;
        }

        .section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 30px 0 15px 0;
            color: #333;
        }

        .section p {
            margin-bottom: 16px;
            color: #444;
        }

        .section ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .section li {
            margin-bottom: 8px;
            color: #444;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            background: #e3f2fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #1565c0;
        }

        pre code {
            background: none;
            padding: 0;
            color: #d4d4d4;
        }

        .img-container {
            margin: 30px 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .img-caption {
            margin-top: 12px;
            font-size: 0.85rem;
            color: #666;
        }

        /* 질문-답변 박스 */
        .qa-box {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #eee;
        }

        .qa-box.question {
            border-left: 4px solid #FF9800;
            background: #FFF8E1;
        }

        .qa-box.answer {
            border-left: 4px solid #4CAF50;
            background: #E8F5E9;
        }

        .qa-box.key {
            border-left: 4px solid #2196F3;
            background: #E3F2FD;
        }

        .qa-box h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .highlight-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .highlight-box h4 {
            color: #1565c0;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .formula-box {
            background: white;
            border: 2px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }

        .formula {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1.2rem;
            color: #1565c0;
            margin: 10px 0;
        }

        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .param-table th,
        .param-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .param-table th {
            background: #2196F3;
            color: white;
            font-weight: 600;
        }

        .param-table tr:last-child td {
            border-bottom: none;
        }

        .diagram {
            background: #263238;
            color: #ECEFF1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre;
            overflow-x: auto;
            margin: 20px 0;
        }

        .step-card {
            background: linear-gradient(135deg, #42A5F5 0%, #1976D2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin: 24px 0;
        }

        .step-card h3 {
            color: white;
            margin-top: 0;
            font-size: 1.3rem;
        }

        .step-card p {
            color: rgba(255,255,255,0.9);
        }

        .concept-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .concept-flow .item {
            background: #e3f2fd;
            padding: 8px 16px;
            border-radius: 20px;
            color: #1565c0;
        }

        .concept-flow .arrow {
            color: #2196F3;
            font-weight: bold;
        }

        .summary-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .summary-box h4 {
            color: #64B5F6;
            margin-bottom: 16px;
        }

        .footer-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 60px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
        }

        .footer-nav a {
            color: #2196F3;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .footer-nav a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a href="../../../">← 메인</a>
            <a href="../category-gpu/">← GPU 카테고리</a>
        </nav>

        <header class="header">
            <h1>Water Rendering (물/파도 렌더링)</h1>
            <div class="header-meta">
                <span>작성일: 2025-01-13</span>
                <span>난이도: 중급</span>
            </div>
            <div class="tags">
                <span class="tag">DirectX 11</span>
                <span class="tag">HLSL</span>
                <span class="tag">Fresnel</span>
                <span class="tag">Reflection</span>
                <span class="tag">Refraction</span>
                <span class="tag">Gerstner Wave</span>
            </div>
        </header>

        <!-- 미리보기 이미지 -->
        <div class="img-container">
            <img src="./images/step9.gif" alt="물 렌더링 최종 결과" onerror="this.style.display='none'">
            <p class="img-caption">물/파도 렌더링 최종 결과 - 프레넬, 반사, 굴절, Gerstner 파도</p>
        </div>

        <!-- 개요 -->
        <section class="section">
            <h2>물은 왜 어렵게 느껴질까?</h2>
            <p>
                게임에서 물을 보면 굉장히 복잡해 보입니다.
                출렁이는 파도, 하늘이 비치는 반사, 물 밑이 보이는 굴절...
            </p>
            <p>
                하지만 하나씩 뜯어보면, 물 렌더링은 <strong>7가지 핵심 개념</strong>의 조합입니다:
            </p>

            <div class="concept-flow">
                <span class="item">파도 형태</span>
                <span class="arrow">→</span>
                <span class="item">법선 계산</span>
                <span class="arrow">→</span>
                <span class="item">프레넬</span>
                <span class="arrow">→</span>
                <span class="item">반사</span>
                <span class="arrow">+</span>
                <span class="item">굴절</span>
                <span class="arrow">+</span>
                <span class="item">깊이</span>
                <span class="arrow">→</span>
                <span class="item">Gerstner</span>
            </div>

            <p>
                이 문서에서는 <strong>소크라테스식 질문</strong>을 통해 하나씩 이해해봅시다.
            </p>
        </section>

        <!-- Part 1: 프레넬 -->
        <section class="section">
            <h2>Part 1: 프레넬 효과 - 물의 핵심</h2>

            <h3>질문 1: 물을 바라보는 각도</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>수영장이나 호수에 서 있다고 상상해보세요.</p>
                <ul>
                    <li><strong>상황 A:</strong> 물 바로 위에서 아래를 내려다볼 때</li>
                    <li><strong>상황 B:</strong> 멀리서 수평에 가깝게 물 표면을 바라볼 때</li>
                </ul>
                <p>두 상황에서 물이 어떻게 다르게 보이나요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답</h4>
                <p><strong>위에서 보면</strong> → 물 밑 바닥이 잘 보임 (투과)</p>
                <p><strong>옆에서 보면</strong> → 하늘/풍경이 반사됨 (반사)</p>
            </div>

            <div class="diagram">        위에서 봄 (수직)          옆에서 봄 (수평)
              👁                           👁
              ↓                              ↘
        ═══════════════              ═══════════════
              ↓
           바닥 보임                     하늘 반사됨
            (투과)                        (반사)</div>

            <h3>질문 2: 왜 그럴까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>물은 그대로인데, 왜 보는 각도에 따라 다르게 보일까요?</p>
                <p>힌트: 빛이 물 표면에 도달하면 두 가지 일이 동시에 일어납니다.</p>
            </div>

            <div class="qa-box answer">
                <h4>답</h4>
                <p>빛의 일부는 <strong>반사</strong>되고, 일부는 <strong>굴절</strong>(투과)됩니다.</p>
                <p>보는 각도에 따라 이 <strong>비율</strong>이 달라집니다!</p>
                <ul>
                    <li>수직으로 볼 때 → 반사 적음, 굴절 많음</li>
                    <li>수평으로 볼 때 → 반사 많음, 굴절 적음</li>
                </ul>
            </div>

            <div class="highlight-box">
                <h4>이 현상의 이름: 프레넬 효과 (Fresnel Effect)</h4>
                <p>19세기 프랑스 물리학자 오귀스탱 프레넬이 발견한 현상입니다.</p>
            </div>

            <h3>질문 3: 셰이더에서 "각도"를 어떻게 알까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>GPU는 모든 픽셀에서 "시선과 표면의 각도"를 계산해야 합니다.</p>
                <p>셰이더에는 두 가지 정보가 있어요:</p>
                <ul>
                    <li><strong>시선 방향 (V)</strong>: 카메라가 이 점을 바라보는 방향</li>
                    <li><strong>표면 법선 (N)</strong>: 표면에 수직인 방향</li>
                </ul>
                <p>이 두 벡터로 "얼마나 수직/수평인지"를 어떻게 구할까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 내적 (Dot Product)</h4>
                <p>두 벡터의 내적 = 두 방향이 얼마나 같은지를 숫자로 표현</p>
                <pre><code>dot(N, V) = cos(각도)

같은 방향 (수직으로 봄) → cos(0°) = 1
수직 (수평으로 봄) → cos(90°) = 0</code></pre>
            </div>

            <div class="diagram">        시선(V)
          ↓
          ↓
    ──────●────── 표면
          ↑
          N (법선)

dot(N, V) = 1 → 수직으로 봄 → 반사 적음
dot(N, V) = 0 → 수평으로 봄 → 반사 많음</div>

            <h3>질문 4: 반사량 공식 만들기</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>dot 값과 반사량의 관계:</p>
                <ul>
                    <li>수직으로 봄 (dot = 1) → 반사 적어야 함</li>
                    <li>수평으로 봄 (dot = 0) → 반사 많아야 함</li>
                </ul>
                <p>숫자가 반대네요! 어떻게 뒤집을까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 1에서 빼기</h4>
                <pre><code>fresnel = 1 - dot(N, V)

수직 (dot=1) → fresnel = 0 (반사 적음)
수평 (dot=0) → fresnel = 1 (반사 많음)</code></pre>
            </div>

            <div class="formula-box">
                <h4>프레넬 공식</h4>
                <div class="formula">fresnel = 1.0 - dot(N, V)</div>
            </div>

            <!-- Step 1 이미지 -->
            <div class="step-card">
                <h3>Step 1: 프레넬 시각화</h3>
                <p>프레넬 값을 흑백으로 출력하면, 가장자리가 밝고 중앙이 어두운 것을 확인할 수 있습니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step1.gif" alt="Step 1: 프레넬 시각화" onerror="this.style.display='none'">
                <p class="img-caption">Step 1: fresnel = 1 - dot(N, V) - 가장자리가 밝음</p>
            </div>
        </section>

        <!-- Part 2: 파도 -->
        <section class="section">
            <h2>Part 2: 파도 만들기</h2>

            <h3>질문 5: 고요한 물 vs 출렁이는 물</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>프레넬은 "평평한 물"에서의 반사/굴절이었어요.</p>
                <p>진짜 물은 출렁이잖아요. 출렁이면 프레넬 공식에서 뭐가 바뀔까요?</p>
                <pre><code>float fresnel = 1.0 - dot(N, V);

N = 법선, V = 시선</code></pre>
            </div>

            <div class="qa-box answer">
                <h4>답: 법선(N)이 바뀜!</h4>
                <p>물결이 출렁이면 표면 기울기가 변하고, 따라서 법선 방향도 바뀝니다.</p>
            </div>

            <div class="diagram">평평한 물:          출렁이는 물:
    ↑ N                  ↗ N   ↖ N
    │                   /       \
────────────      ～～/～～～～\～～</div>

            <h3>질문 6: 파도 모양을 어떻게 만들까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>주기적으로 위아래로 반복되는 파도 모양을 수학 함수로 표현한다면?</p>
                <div class="diagram">     1 ┤    ╭─╮      ╭─╮
       │   ╱   ╲    ╱   ╲
     0 ┤──╱─────╲──╱─────╲──
       │ ╱       ╲╱       ╲
    -1 ┤╱         </div>
            </div>

            <div class="qa-box answer">
                <h4>답: sin (사인 함수)</h4>
                <pre><code>float height = sin(x);</code></pre>
            </div>

            <h3>질문 7: 파도를 움직이게 하려면?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p><code>sin(x)</code>는 멈춰있는 파도예요.</p>
                <p>시간이 지나면 파도가 밀려오듯 이동해야 해요. 어떻게?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 시간(time)을 빼기</h4>
                <pre><code>sin(x - time)  // 파도가 → 오른쪽으로 이동
sin(x + time)  // 파도가 ← 왼쪽으로 이동</code></pre>
                <p>시간이 증가하면 같은 높이가 되는 x 위치가 이동합니다.</p>
            </div>

            <div class="step-card">
                <h3>Step 2-3: 파도 움직임</h3>
                <p>Step 2는 정적 sin(x), Step 3는 sin(x - time)으로 움직이는 파도입니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step3.gif" alt="Step 3: 움직이는 파도" onerror="this.style.display='none'">
                <p class="img-caption">Step 3: height = sin(x - time) - 파도가 이동</p>
            </div>

            <h3>질문 8: 2D 물 표면으로 확장</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>지금까지는 1차원(x축)이었어요. 물 표면은 2차원(x, z)입니다.</p>
                <p>어떻게 확장할까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 두 방향의 파도를 더하기</h4>
                <pre><code>float height = sin(x - time) + sin(z - time);</code></pre>
            </div>

            <h3>질문 9: 자연스러운 파도</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p><code>sin(x) + sin(z)</code>는 너무 규칙적인 바둑판 패턴이에요.</p>
                <p>실제 물처럼 불규칙하게 만들려면?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 여러 파도를 다른 설정으로 더하기!</h4>
                <pre><code>// 여러 파도 중첩
float wave = sin(x * 1.0 - time * 1.0) * 1.0      // 크고 느린 파도
           + sin(x * 2.3 - time * 1.5) * 0.5      // 중간 파도
           + sin(x * 4.7 - time * 2.0) * 0.25;    // 작고 빠른 파도</code></pre>
                <p>각 파도마다 주파수, 속도, 진폭을 다르게!</p>
            </div>

            <div class="diagram">파도1:  ～～～～～～～    (크고 느림)
파도2:  ∿∿∿∿∿∿∿∿∿∿   (중간)
파도3:  ⋰⋰⋰⋰⋰⋰⋰⋰⋰⋰⋰⋰  (작고 빠름)
─────────────────────────────
합치면: ～∿⋰～∿～⋰∿～   (자연스러움!)</div>

            <div class="step-card">
                <h3>Step 4: 여러 파도 중첩</h3>
                <p>다양한 주파수와 진폭의 파도를 더해서 자연스러운 물결을 만듭니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step4.gif" alt="Step 4: 여러 파도 중첩" onerror="this.style.display='none'">
                <p class="img-caption">Step 4: 여러 사인파 중첩 - 자연스러운 물결</p>
            </div>
        </section>

        <!-- Part 3: 법선 계산 -->
        <section class="section">
            <h2>Part 3: 법선 계산</h2>

            <h3>질문 10: 기울기에서 법선으로</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>파도가 출렁이면 법선이 바뀐다고 했어요.</p>
                <p>"표면의 기울기"와 "법선"은 어떤 관계일까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 법선은 표면에 수직</h4>
                <p>표면 기울기를 알면, 그것에 수직인 방향이 법선입니다.</p>
            </div>

            <h3>질문 11: 기울기는 어떻게 구할까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>파도 높이 함수: <code>height = sin(x)</code></p>
                <p>각 위치에서 기울기를 구하려면?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 미분!</h4>
                <pre><code>height = sin(x)
slope = cos(x)   // sin을 미분하면 cos</code></pre>
            </div>

            <h3>질문 12: 기울기 → 법선 벡터</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>2D에서 기울기가 0이면 법선은 (0, 1) (위쪽).</p>
                <p>기울기가 1이면 (45도 경사) 법선은?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: (-기울기, 1)</h4>
                <p>표면이 오른쪽으로 기울면, 법선은 왼쪽 위를 향합니다.</p>
                <pre><code>// 2D
normal = normalize(-slope, 1)

// 3D (x, z 두 방향)
normal = normalize(-dh/dx, 1, -dh/dz)</code></pre>
            </div>

            <div class="formula-box">
                <h4>3D 법선 공식</h4>
                <div class="formula">N = normalize(-dh/dx, 1.0, -dh/dz)</div>
            </div>

            <div class="step-card">
                <h3>Step 5: 법선 시각화</h3>
                <p>법선 벡터를 색상으로 시각화합니다. (R=X, G=Y, B=Z)</p>
            </div>
            <div class="img-container">
                <img src="./images/step5.gif" alt="Step 5: 법선 시각화" onerror="this.style.display='none'">
                <p class="img-caption">Step 5: 법선 벡터 시각화 - 파도에 따라 법선이 변화</p>
            </div>
        </section>

        <!-- Part 4: 반사와 굴절 -->
        <section class="section">
            <h2>Part 4: 반사와 굴절</h2>

            <h3>질문 13: 반사 - 하늘을 어떻게 가져올까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>반사된 "하늘색"을 가져와야 해요.</p>
                <p>하늘은 모든 방향에 있는데, 어떤 텍스처로 저장할까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 큐브맵 (Cubemap)</h4>
                <p>정육면체 6면에 환경을 담아둡니다.</p>
                <pre><code>// 방향 벡터로 큐브맵 샘플링
vec3 color = texture(cubemap, direction).rgb;</code></pre>
            </div>

            <div class="diagram">      ┌───┐
      │ 위 │ (하늘)
  ┌───┼───┼───┬───┐
  │ 좌 │ 앞 │ 우 │ 뒤 │
  └───┼───┼───┴───┘
      │ 아래│ (땅)
      └───┘

방향 벡터를 넣으면 → 그 방향의 색이 나옴</div>

            <h3>질문 14: 반사 방향 구하기</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>시선 벡터(V)와 법선(N)이 있을 때, 반사 방향(R)은?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: reflect() 함수</h4>
                <p>입사각 = 반사각 원리를 이용합니다.</p>
                <pre><code>vec3 R = reflect(-V, N);  // 반사 방향
vec3 reflectColor = texture(cubemap, R).rgb;</code></pre>
            </div>

            <div class="step-card">
                <h3>Step 6: 반사 구현</h3>
                <p>큐브맵으로 하늘/환경을 반사시킵니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step6.gif" alt="Step 6: 반사" onerror="this.style.display='none'">
                <p class="img-caption">Step 6: 큐브맵 반사 - 파도에 따라 반사 이미지가 일렁임</p>
            </div>

            <h3>질문 15: 굴절 - 물 밑은 어떻게?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>빨대를 물컵에 넣으면 꺾여 보이잖아요. 왜 그럴까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 빛의 속도가 다르기 때문</h4>
                <p>공기보다 물에서 빛이 느리게 이동 → 굴절 발생</p>
                <pre><code>// 굴절률 (Index of Refraction)
공기: IOR ≈ 1.0
물:   IOR ≈ 1.33

// 굴절 방향
float eta = 1.0 / 1.33;
vec3 T = refract(-V, N, eta);</code></pre>
            </div>

            <div class="step-card">
                <h3>Step 7: 굴절 구현</h3>
                <p>물 밑 씬을 굴절시켜서 렌더링합니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step7.gif" alt="Step 7: 굴절" onerror="this.style.display='none'">
                <p class="img-caption">Step 7: 굴절 - 물 밑이 왜곡되어 보임</p>
            </div>

            <h3>프레넬로 반사/굴절 섞기</h3>
            <div class="highlight-box">
                <h4>최종 조합</h4>
                <p>프레넬 값으로 반사와 굴절을 섞습니다:</p>
                <pre><code>float fresnel = 1.0 - dot(N, V);
vec3 finalColor = mix(refractColor, reflectColor, fresnel);

// fresnel이 크면 (수평으로 봄) → 반사 많음
// fresnel이 작으면 (수직으로 봄) → 굴절 많음</code></pre>
            </div>

            <div class="step-card">
                <h3>Step 8: 최종 Sin 파도</h3>
                <p>프레넬, 반사, 굴절, 깊이를 모두 합쳐서 사실적인 물을 완성합니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step8.gif" alt="Step 8: 최종" onerror="this.style.display='none'">
                <p class="img-caption">Step 8: 모든 요소 조합 - 프레넬, 반사, 굴절, 깊이</p>
            </div>
        </section>

        <!-- Part 5: 깊이 -->
        <section class="section">
            <h2>Part 5: 물의 깊이</h2>

            <h3>질문 16: 깊이에 따른 색상</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>실제 물을 보면:</p>
                <ul>
                    <li>얕은 곳 → 맑고 밝음, 바닥 잘 보임</li>
                    <li>깊은 곳 → 어둡고 푸름, 바닥 안 보임</li>
                </ul>
                <p>셰이더에서 "깊이"를 어떻게 알 수 있을까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 깊이 버퍼 활용</h4>
                <pre><code>// 물 표면 깊이와 바닥 깊이 비교
float surfaceDepth = screenPos.z;
float bottomDepth = texture(depthBuffer, screenUV).r;
float waterDepth = bottomDepth - surfaceDepth;

// 깊이에 따른 색상
vec3 shallowColor = vec3(0.0, 0.8, 0.8);  // 밝은 청록
vec3 deepColor = vec3(0.0, 0.1, 0.3);     // 어두운 남색
vec3 waterColor = mix(shallowColor, deepColor, waterDepth);</code></pre>
            </div>

            <div class="highlight-box">
                <h4>깊이 효과</h4>
                <p>Step 8의 최종 결과에 깊이 기반 색상이 포함되어 있습니다.</p>
                <p>중앙(깊음)은 어둡고, 가장자리(얕음)는 밝게 표현됩니다.</p>
            </div>
        </section>

        <!-- Part 6: Gerstner Wave -->
        <section class="section">
            <h2>Part 6: Gerstner Wave - 사실적인 파도</h2>

            <div class="highlight-box">
                <h4>기본 지식의 마지막 단계</h4>
                <p>sin 파도는 부드럽지만, 실제 바다 파도는 꼭대기가 뾰족합니다.</p>
                <p>Gerstner Wave는 "기본 지식"과 "고급 기법" 사이의 경계선입니다.</p>
            </div>

            <h3>질문 17: sin 파도의 한계</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>지금까지 만든 sin 파도를 보면:</p>
                <ul>
                    <li>위아래로 똑같이 둥글게 움직임</li>
                    <li>꼭대기와 바닥이 대칭</li>
                </ul>
                <p>실제 바다 파도는 어떻게 다른가요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 실제 파도는 꼭대기가 뾰족함!</h4>
                <p>파도 꼭대기는 날카롭고, 골은 넓고 평평합니다.</p>
            </div>

            <div class="diagram">  sin 파도:           실제 파도:
    ╭─╮   ╭─╮          ∧     ∧
   ╱   ╲ ╱   ╲        / \   / \
──╱─────╲─────╲──   ─/   \_/   \_─
   (둥글둥글)          (뾰족!)</div>

            <h3>질문 18: 왜 뾰족해질까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>물 입자가 파도를 따라 움직인다고 상상해보세요.</p>
                <p>sin 파도에서 입자는 위아래로만 움직입니다.</p>
                <p>실제 물에서는 입자가 어떻게 움직일까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: 원운동 (Circular Motion)</h4>
                <p>실제 물 입자는 <strong>원을 그리며</strong> 움직습니다!</p>
                <pre><code>// sin 파도: 위아래만
y = sin(phase)

// Gerstner 파도: 원운동
x += cos(phase)  // 좌우로도 움직임
y = sin(phase)</code></pre>
            </div>

            <div class="diagram">sin 파도 입자:        Gerstner 입자:
      ↑                    ╭→
      │                  ↑    ↓
      ↓                    ←╯
   (위아래만)            (원운동!)</div>

            <h3>질문 19: 원운동이 왜 뾰족함을 만들까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>파도 위의 입자가 원운동을 합니다.</p>
                <p>꼭대기(sin 최대)에서 입자들이 어느 방향으로 움직일까요?</p>
                <ul>
                    <li>sin이 최대일 때, cos은 몇?</li>
                    <li>이때 입자들은 x축으로 어떻게 모이나요?</li>
                </ul>
            </div>

            <div class="qa-box answer">
                <h4>답: 꼭대기로 모인다!</h4>
                <p>sin이 최대일 때 cos = 0 (전후 이동 없음)</p>
                <p>하지만 sin이 0일 때 cos = ±1 (좌우로 최대 이동)</p>
                <p>결과: <strong>입자들이 꼭대기로 몰려서 뾰족해짐!</strong></p>
                <pre><code>// 입자 위치 변화
x = x_original + Q * A * cos(phase)  // Q = steepness
y = A * sin(phase)

// phase가 진행됨에 따라:
// - 골에서는 입자가 흩어짐 (넓어짐)
// - 꼭대기에서는 입자가 모임 (뾰족해짐)</code></pre>
            </div>

            <div class="diagram">       입자 이동 방향:
     →  →  ∧  ←  ←
    ↗     ↑     ↖
───●───●───●───●───●───
     ↖     ↓     ↗
     ←     ∨     →
       (꼭대기로 모임!)</div>

            <h3>질문 20: 파도가 부서지는 조건?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>steepness(Q)를 너무 높이면 파도가 말리거나 부서집니다.</p>
                <p>수학적으로 어떤 조건을 넘으면 안 될까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: A × k &lt; 1</h4>
                <p>A(진폭) × k(주파수)가 1 이상이면 파도가 자기 자신을 넘어가서 "말림"</p>
                <pre><code>// 안전한 파도 조건
amplitude * frequency < 1.0

// 또는 steepness로 제어
Q = min(steepness, 1.0 / (A * k))</code></pre>
            </div>

            <h3>질문 21: 법선 계산은 어떻게 달라질까?</h3>
            <div class="qa-box question">
                <h4>생각해보기</h4>
                <p>sin 파도는 y만 변했지만, Gerstner는 x, z도 변합니다.</p>
                <p>법선 계산에 어떤 영향이 있을까요?</p>
            </div>

            <div class="qa-box answer">
                <h4>답: x 변위도 미분에 포함</h4>
                <pre><code>// Gerstner 법선 공식 (각 파도마다)
Nx += -D.x * k * A * cos(phase)
Nz += -D.y * k * A * cos(phase)
Ny += Q * k * A * sin(phase)

// 최종 법선
N = normalize(Nx, 1.0 - Ny, Nz)</code></pre>
            </div>

            <div class="formula-box">
                <h4>Gerstner Wave 공식</h4>
                <div class="formula">
                    x' = x + Q × A × D.x × cos(k·D·pos - ωt)<br>
                    z' = z + Q × A × D.y × cos(k·D·pos - ωt)<br>
                    y' = A × sin(k·D·pos - ωt)
                </div>
                <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                    Q = steepness, A = amplitude, D = direction, k = frequency, ω = speed
                </p>
            </div>

            <div class="step-card">
                <h3>Step 9: Gerstner Wave</h3>
                <p>원운동 기반의 사실적인 파도를 구현합니다. 꼭대기가 뾰족하고 반사가 더 선명합니다.</p>
            </div>
            <div class="img-container">
                <img src="./images/step9.gif" alt="Step 9: Gerstner Wave" onerror="this.style.display='none'">
                <p class="img-caption">Step 9: Gerstner Wave - 뾰족한 파도 꼭대기와 역동적인 반사</p>
            </div>

            <div class="summary-box">
                <h4>Gerstner vs Sin 파도 비교</h4>
                <pre><code>// Sin 파도 (Step 1-8)
- y만 변함: y = sin(phase)
- 둥근 파도, 구현 간단
- 법선 계산: dh/dx만 필요

// Gerstner 파도 (Step 9)
- x, y, z 모두 변함
- 뾰족한 파도, 더 사실적
- 법선 계산: x 변위도 고려
- 파도가 부서지지 않게 A*k < 1 제한</code></pre>
            </div>
        </section>

        <!-- 전체 정리 -->
        <section class="section">
            <h2>전체 구현 정리</h2>

            <div class="summary-box">
                <h4>물 렌더링 최종 코드 구조</h4>
                <pre><code>// 1. 파도 높이 계산 (Vertex Shader)
float height = sin(pos.x * freq1 - time * speed1) * amp1
             + sin(pos.z * freq2 - time * speed2) * amp2
             + sin((pos.x + pos.z) * freq3 - time * speed3) * amp3;

// 2. 법선 계산 (미분)
float dh_dx = cos(pos.x * freq1 - time * speed1) * freq1 * amp1 + ...;
float dh_dz = cos(pos.z * freq2 - time * speed2) * freq2 * amp2 + ...;
vec3 N = normalize(vec3(-dh_dx, 1.0, -dh_dz));

// 3. 프레넬 (Pixel Shader)
vec3 V = normalize(cameraPos - worldPos);
float fresnel = 1.0 - saturate(dot(N, V));

// 4. 반사
vec3 R = reflect(-V, N);
vec3 reflectColor = textureCube(cubemap, R).rgb;

// 5. 굴절
vec3 T = refract(-V, N, 1.0/1.33);
vec3 refractColor = texture(sceneTexture, screenUV + N.xz * distortion).rgb;

// 6. 깊이
float depth = getWaterDepth(screenUV);
vec3 depthColor = mix(shallowColor, deepColor, saturate(depth));

// 7. 최종 조합
vec3 waterColor = mix(refractColor, reflectColor, fresnel);
vec3 finalColor = waterColor * depthColor;</code></pre>
            </div>

            <table class="param-table">
                <thead>
                    <tr>
                        <th>단계</th>
                        <th>개념</th>
                        <th>핵심 코드</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>파도 형태</td>
                        <td><code>sin(x - time)</code> 여러 개 합침</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>법선 계산</td>
                        <td><code>N = normalize(-dh/dx, 1, -dh/dz)</code></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>프레넬</td>
                        <td><code>fresnel = 1 - dot(N, V)</code></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>반사</td>
                        <td><code>reflect(-V, N)</code> → 큐브맵</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>굴절</td>
                        <td><code>refract(-V, N, eta)</code></td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>깊이</td>
                        <td>깊이 버퍼로 색상 보간</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Gerstner</td>
                        <td>원운동: x += Q*A*cos, y = A*sin</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- 추가 학습 -->
        <section class="section">
            <h2>더 알아볼 것들 (고급)</h2>

            <p>Gerstner Wave까지가 "기본 지식"의 범위입니다. 아래는 더 고급 기법들:</p>
            <ul>
                <li><strong>거품 (Foam)</strong>: 파도가 부서질 때 하얀 거품 - Jacobian으로 접힘 감지</li>
                <li><strong>코스틱 (Caustics)</strong>: 물 밑에 일렁이는 빛 무늬 - 굴절 경로 추적</li>
                <li><strong>SSS (Subsurface Scattering)</strong>: 빛이 물 속에서 퍼지는 효과</li>
                <li><strong>FFT Ocean</strong>: Tessendorf의 통계적 해양 시뮬레이션</li>
                <li><strong>Physical Water Simulation</strong>: SPH, PBD 등 입자 기반 시뮬레이션</li>
            </ul>
        </section>

        <footer class="footer-nav">
            <a href="../shader-techniques/">← 쉐이더 테크닉</a>
            <a href="../../">메인으로 →</a>
        </footer>
    </div>
</body>
</html>
