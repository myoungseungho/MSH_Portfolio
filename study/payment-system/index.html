<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인앱 결제 시스템 - MSH Portfolio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            color: #333;
            line-height: 1.8;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 60px 20px; }
        .back-link {
            display: inline-block;
            margin-bottom: 24px;
            color: #666;
            text-decoration: none;
        }
        .back-link:hover { color: #111; }
        .header { margin-bottom: 48px; }
        .header h1 { font-size: 2rem; font-weight: 700; color: #111; margin-bottom: 8px; }
        .header p { color: #666; }

        .section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #eee;
        }
        .section h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #111;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        .section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 24px 0 12px 0;
        }
        .section p {
            margin-bottom: 16px;
            color: #444;
        }
        .question {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .question strong {
            color: #f57c00;
        }
        .answer {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .answer strong {
            color: #2e7d32;
        }
        .flow-diagram {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 24px;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .highlight {
            background: #fff3e0;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .warning {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px 16px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            margin: 16px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        ul, ol {
            margin: 16px 0;
            padding-left: 24px;
        }
        li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../category-web/" class="back-link">← 웹서버 (Node.js)</a>

        <header class="header">
            <h1>인앱 결제 시스템</h1>
            <p>모바일 게임 결제 흐름과 보안</p>
        </header>

        <!-- 1. 시작점 -->
        <section class="section">
            <h2>1. 결제 버튼을 누르면?</h2>

            <div class="question">
                <strong>Q:</strong> 게임에서 유저가 "캐쉬 100개 - 5,000원" 버튼을 눌렀다. 클라이언트(게임 앱)는 가장 먼저 누구한테 뭘 요청할까?
            </div>

            <div class="answer">
                <strong>A:</strong> 스토어(구글 플레이, 앱스토어, 원스토어 등)한테 결제를 요청한다.
            </div>

            <p>게임사가 직접 신용카드 정보를 받는 건 위험하고 복잡해. 그래서 <span class="highlight">스토어가 결제를 대신 처리</span>해준다.</p>

            <ul>
                <li>구글 플레이 → 안드로이드 기본</li>
                <li>앱스토어 → iOS 기본</li>
                <li>원스토어 → 한국 안드로이드</li>
                <li>갤럭시 스토어 → 삼성 기기</li>
            </ul>
        </section>

        <!-- 2. 영수증 -->
        <section class="section">
            <h2>2. 결제 후 뭘 받을까?</h2>

            <div class="question">
                <strong>Q:</strong> 스토어에서 결제가 완료됐다. 클라이언트가 게임 서버한테 "나 결제했어, 캐쉬 줘!"라고 말해야 하는데... 해커가 결제 안 하고 거짓말하면?
            </div>

            <div class="answer">
                <strong>A:</strong> 영수증이 필요하다! 스토어가 결제 완료 시 클라이언트에게 영수증을 발급해준다.
            </div>

            <div class="warning">
                <strong>문제:</strong> 영수증도 조작할 수 있지 않을까? 영수증의 진위를 판별할 방법이 필요하다.
            </div>
        </section>

        <!-- 3. 영수증 검증 -->
        <section class="section">
            <h2>3. 영수증 검증은 누구한테?</h2>

            <div class="question">
                <strong>Q:</strong> 영수증의 진위를 누구한테 물어봐야 할까?
                <ul>
                    <li>클라이언트한테? (신뢰할 수 있어?)</li>
                    <li>우리 DB에? (우리가 발급한 게 아닌데?)</li>
                </ul>
            </div>

            <div class="answer">
                <strong>A:</strong> 영수증을 발급한 스토어한테 직접 "이 영수증 진짜야?"라고 물어본다!
            </div>

            <p><span class="highlight">서버 측 영수증 검증 (Server-side Receipt Validation)</span> - 구글/애플이 공식적으로 권장하는 방식이다.</p>

            <div class="flow-diagram">
클라이언트 → 결제 서버: "이 영수증으로 캐쉬 줘"
     ↓
결제 서버 → 구글/애플: "이 영수증 진짜야?"
     ↓
구글/애플 → 결제 서버: "응, 진짜야" 또는 "가짜야"
            </div>
        </section>

        <!-- 4. 중복 방지 -->
        <section class="section">
            <h2>4. 같은 영수증을 두 번 보내면?</h2>

            <div class="question">
                <strong>Q:</strong> 만약 같은 영수증을 두 번, 세 번 보내면? 스토어한테 물어보면 매번 "진짜야"라고 할 텐데... 캐쉬를 무한으로 받을 수 있는 거 아니야?
            </div>

            <div class="answer">
                <strong>A:</strong> 우리 서버 DB에서 "이 영수증으로 이미 지급했는지" 기록해둔다!
            </div>

            <h3>영수증 저장 및 중복 체크</h3>

            <div class="flow-diagram">
1. 영수증을 DB에 저장 시도
2. 저장 성공하면 → 아이템 지급
3. 저장 실패하면 (이미 존재) → 중복이므로 거부
            </div>

            <table>
                <tr>
                    <th>요청</th>
                    <th>DB 저장 결과</th>
                    <th>아이템 지급</th>
                </tr>
                <tr>
                    <td>첫 번째</td>
                    <td>성공 (ID 반환)</td>
                    <td>O 지급!</td>
                </tr>
                <tr>
                    <td>두 번째 (같은 영수증)</td>
                    <td>실패 (0 반환)</td>
                    <td>X 거부</td>
                </tr>
            </table>

            <p>DB에서 같은 영수증 번호(order_id)로 두 번 저장하려고 하면 실패하도록 설계되어 있다.</p>
        </section>

        <!-- 5. consume -->
        <section class="section">
            <h2>5. 스토어한테도 알려준다 - 영수증 소비 처리</h2>

            <div class="question">
                <strong>Q:</strong> 우리 DB에만 기록하면 끝일까?
            </div>

            <div class="answer">
                <strong>A:</strong> 스토어한테도 "이 영수증 사용 완료했어"라고 알려준다!
            </div>

            <div class="flow-diagram">
1. 영수증 상태 확인 (결제 완료 & 아직 미사용)
2. 맞으면 → 스토어에 "소비 완료" 요청
            </div>

            <h3>이중 안전장치</h3>

            <table>
                <tr>
                    <th>위치</th>
                    <th>방법</th>
                    <th>역할</th>
                </tr>
                <tr>
                    <td>우리 DB</td>
                    <td>영수증 저장 - 같은 order_id 저장 불가</td>
                    <td>우리 서버 내 중복 방지</td>
                </tr>
                <tr>
                    <td>스토어 서버</td>
                    <td>영수증 소비 처리 - "소비됨" 표시</td>
                    <td>스토어 측 중복 방지</td>
                </tr>
            </table>

            <p><strong>왜 둘 다 필요할까?</strong></p>
            <ul>
                <li>우리 DB만 있으면: 다른 게임사가 같은 영수증 악용 가능</li>
                <li>스토어만 있으면: 우리 서버 동시 요청 시 타이밍 이슈 발생 가능</li>
            </ul>
        </section>

        <!-- 6. 전체 흐름 -->
        <section class="section">
            <h2>6. 전체 흐름 정리</h2>

            <div class="flow-diagram">
[유저] → 캐쉬 100개 구매 클릭
    ↓
[스토어] ← 결제 처리 → 영수증 발급
    ↓
[클라이언트] → 영수증을 결제 서버로 전송
    ↓
[결제 서버] → 스토어한테 "이 영수증 진짜야?" 확인
    ↓
    ├─ 가짜면 → 거부
    └─ 진짜면 ↓
              ↓
         DB에 영수증 저장 시도
              ↓
              ├─ 이미 있으면 → 중복! 거부
              └─ 없으면 ↓
                        ↓
                   아이템 지급
                        ↓
                   스토어에 "소비 완료" 알림
                        ↓
                   클라이언트에게 성공 응답
            </div>
        </section>

        <!-- 7. 스토어별 처리 -->
        <section class="section">
            <h2>7. 왜 스토어마다 다른 처리가 필요할까?</h2>

            <div class="flow-diagram">
스토어 종류에 따라 분기:
- 애플이면 → 애플 검증 로직 실행
- 구글이면 → 구글 검증 로직 실행
- 갤럭시면 → 갤럭시 검증 로직 실행
- 원스토어면 → 원스토어 검증 로직 실행
            </div>

            <div class="question">
                <strong>Q:</strong> Firebase처럼 통합 라이브러리는 없을까?
            </div>

            <div class="answer">
                <strong>A:</strong> 각 스토어가 영수증 검증 방식 자체가 다르기 때문에 통합이 어렵다.
            </div>

            <table>
                <tr>
                    <th>스토어</th>
                    <th>검증 방식</th>
                    <th>특징</th>
                </tr>
                <tr>
                    <td>Google</td>
                    <td>Google Play API 호출</td>
                    <td>OAuth 인증, googleapis 라이브러리</td>
                </tr>
                <tr>
                    <td>Apple</td>
                    <td>Apple 서버에 영수증 전송</td>
                    <td>영수증 자체가 암호화된 형태</td>
                </tr>
                <tr>
                    <td>OneStore</td>
                    <td>OneStore API 호출</td>
                    <td>한국 전용, 별도 인증</td>
                </tr>
                <tr>
                    <td>Galaxy</td>
                    <td>Samsung 서버 검증</td>
                    <td>삼성 전용 API</td>
                </tr>
            </table>

            <p>Firebase가 로그인을 통합할 수 있었던 건 <strong>"인증"이라는 결과만 같으면 됐기 때문</strong>. 하지만 결제는 영수증 형식, API 주소, 인증 방법, 응답 형식이 다 달라서 통합이 어렵다.</p>
        </section>

        <!-- 8. 핵심 정리 -->
        <section class="section">
            <h2>8. 핵심 정리</h2>

            <table>
                <tr>
                    <th>개념</th>
                    <th>설명</th>
                    <th>왜 필요한가</th>
                </tr>
                <tr>
                    <td>영수증 (Receipt)</td>
                    <td>스토어가 발급하는 결제 증명</td>
                    <td>클라이언트의 "결제했어" 주장을 증명</td>
                </tr>
                <tr>
                    <td>서버 측 검증</td>
                    <td>스토어 API로 영수증 진위 확인</td>
                    <td>위조 영수증 차단</td>
                </tr>
                <tr>
                    <td>DB 기록</td>
                    <td>영수증 정보를 DB에 저장</td>
                    <td>같은 영수증 중복 사용 방지</td>
                </tr>
                <tr>
                    <td>영수증 소비 처리</td>
                    <td>스토어에 "사용 완료" 알림</td>
                    <td>스토어 측 중복 방지</td>
                </tr>
                <tr>
                    <td>스토어별 처리</td>
                    <td>각 스토어 API에 맞는 검증 로직</td>
                    <td>스토어마다 방식이 다름</td>
                </tr>
            </table>
        </section>
    </div>
</body>
</html>
